<!-- Profile Selector -->
<div id="profile-selector-widget" class="profile-selector-container mb-5">
  <div class="text-center mb-4">
    <h2>Select your profile to see personalised content</h2>
  </div>

  <div class="row profile-cards">
    <div class="col-xl-3 col-lg-3 col-md-6 mb-3">
      <div class="card profile-card h-100 clickable-card"
           data-usergroup="policymakers"
           tabindex="0"
           role="button"
           aria-label="Select Policymakers profile">
        <div class="card-body text-center">
          <div class="profile-icon mb-3">
            <i class="fas fa-balance-scale fa-3x"></i>
          </div>
          <h3 class="card-title">Policymakers</h3>
          <p class="card-text">AI Policy guidance, regulations and frameworks</p>
          <div class="selection-indicator">
            <span class="select-text">Click to Select</span>
            <span class="selected-text" style="display:none;">Selected</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-3 col-md-6 mb-3">
      <div class="card profile-card h-100 clickable-card"
           data-usergroup="educators"
           tabindex="0"
           role="button"
           aria-label="Select Educators profile">
        <div class="card-body text-center">
          <div class="profile-icon mb-3">
            <i class="fas fa-chalkboard-teacher fa-3x"></i>
          </div>
          <h3 class="card-title">Educators</h3>
          <p class="card-text">Tools, teaching strategies and integration guides</p>
          <div class="selection-indicator">
            <span class="select-text">Click to Select</span>
            <span class="selected-text" style="display:none;">Selected</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-3 col-md-6 mb-3">
      <div class="card profile-card h-100 clickable-card"
           data-usergroup="parents"
           tabindex="0"
           role="button"
           aria-label="Select Parents profile">
        <div class="card-body text-center">
          <div class="profile-icon mb-3">
            <i class="fas fa-users fa-3x"></i>
          </div>
          <h3 class="card-title">Parents</h3>
          <p class="card-text">AI’s impact on children’s privacy and education</p>
          <div class="selection-indicator">
            <span class="select-text">Click to Select</span>
            <span class="selected-text" style="display:none;">Selected</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-3 col-md-6 mb-3">
      <div class="card profile-card h-100 clickable-card"
           data-usergroup="students"
           tabindex="0"
           role="button"
           aria-label="Select Students profile">
        <div class="card-body text-center">
          <div class="profile-icon mb-3">
            <i class="fas fa-graduation-cap fa-3x"></i>
          </div>
          <h3 class="card-title">Students</h3>
          <p class="card-text">Learn about AI and digital tools for learning</p>
          <div class="selection-indicator">
            <span class="select-text">Click to Select</span>
            <span class="selected-text" style="display:none;">Selected</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center mt-3">
    <div>
      <button
        type="button"
        class="btn btn-outline-primary gap-4"
        style="min-width: 45px; min-height: 45px; text-align: center;"
        onclick="window.location.href='/learn-and-toolkit/';"
      >
        Browse Tools
      </button>

      <button
        id="clear-profile"
        class="btn btn-outline-primary"
        style="min-width: 45px; min-height: 45px; text-align: center;"
      >
        Clear Profile Selection
      </button>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    // Check current user group from URL
    var currentUserGroup = UserProfile.getCurrentUserGroup();

    if (currentUserGroup) {
      activateUserGroup(currentUserGroup);
      showUserGroupContent(currentUserGroup);
    }

    // Handle card click AND keyboard events
    $('.clickable-card').on('click keydown', function(e) {
      // Only proceed for clicks or Enter/Space key presses
      if (e.type === 'click' || e.which === 13 || e.which === 32) {
        e.preventDefault(); // Prevent space from scrolling page

        var userGroup = $(this).attr('data-usergroup');
        selectUserGroup(userGroup);
      }
    });

    // Clear user group selection - already has keyboard support as it's a button
    $('#clear-profile').click(function() {
      clearUserGroup();
    });

    // Extracted function for selecting user group
    function selectUserGroup(userGroup) {
      // Update URL without refresh
      var url = new URL(window.location);
      url.searchParams.set('usergroup', userGroup);
      history.pushState({}, '', url.toString());

      // Reset ALL cards first
      $('.profile-card').removeClass('selected');
      $('.profile-card').attr('aria-pressed', 'false');
      $('.profile-card').find('.select-text').show();
      $('.profile-card').find('.selected-text').hide();

      // Then update the clicked card
      var selectedCard = $('.profile-card[data-usergroup="' + userGroup + '"]');
      selectedCard.addClass('selected');
      selectedCard.attr('aria-pressed', 'true');
      selectedCard.find('.select-text').hide();
      selectedCard.find('.selected-text').show();
      $('#clear-profile').show();

      // Update content display
      if (typeof updateContentDisplay === 'function') {
        updateContentDisplay(userGroup);
      }

      // Update ALL links
      $('a[href^="/"], a[href^="' + window.location.origin + '"]').each(function() {
        var href = $(this).attr('href');

        if (href && !href.startsWith('#')) {
          try {
            var linkUrl = new URL(href, window.location.origin);

            if (linkUrl.origin === window.location.origin) {
              linkUrl.searchParams.set('usergroup', userGroup);
              $(this).attr('href', linkUrl.toString());
            }
          } catch (e) {
            // Invalid URL, skip
          }
        }
      });
    }

    // Extracted function for clearing user group
    function clearUserGroup() {
      // Update URL without refresh
      var url = new URL(window.location);
      url.searchParams.delete('usergroup');
      history.pushState({}, '', url.toString());

      // Reset UI
      $('.profile-card').removeClass('selected');
      $('.profile-card').attr('aria-pressed', 'false');
      $('.profile-card').find('.select-text').show();
      $('.profile-card').find('.selected-text').hide();
      $('#clear-profile').hide();

      // Clear content display
      if (typeof updateContentDisplay === 'function') {
        updateContentDisplay('all');
      }

      // Remove usergroup from all links
      $('a[href^="/"], a[href^="' + window.location.origin + '"]').each(function() {
        var href = $(this).attr('href');

        if (href && !href.startsWith('#')) {
          try {
            var linkUrl = new URL(href, window.location.origin);

            if (linkUrl.origin === window.location.origin) {
              linkUrl.searchParams.delete('usergroup');
              $(this).attr('href', linkUrl.toString());
            }
          } catch (e) {
            // Invalid URL, skip
          }
        }
      });
    }

    function activateUserGroup(userGroup) {
      var card = $('.profile-card[data-usergroup="' + userGroup + '"]');
      card.addClass('selected');
      card.attr('aria-pressed', 'true');
      card.find('.select-text').hide();
      card.find('.selected-text').show();
      $('#clear-profile').show();
    }

    function showUserGroupContent(userGroup) {
      if (typeof updateContentDisplay === 'function') {
        updateContentDisplay(userGroup);
      }
    }
  });
</script>
